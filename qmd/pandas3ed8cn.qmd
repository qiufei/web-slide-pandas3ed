---
title: "Python æ•°æ®åˆ†æ"
subtitle: "ç¬¬ 8 ç« "
---

## å¼•è¨€ï¼šæ•°æ®æ•´ç† - è¿æ¥ã€åˆå¹¶å’Œé‡å¡‘ ğŸ—‚ï¸

<!-- ğŸ—‚ï¸ æ˜¯ä¸€ä¸ªæ–‡ä»¶å¤¹å›¾æ ‡ï¼Œç”¨äºå½¢è±¡åœ°è¡¨ç¤ºæ•°æ®æ•´ç† -->

*   åœ¨è®¸å¤šåº”ç”¨ä¸­ï¼Œæ•°æ®åˆ†æ•£åœ¨å¤šä¸ªæ–‡ä»¶æˆ–æ•°æ®åº“ä¸­ã€‚
*   æ•°æ®çš„ç»„ç»‡å½¢å¼ä¹Ÿå¯èƒ½ä¸åˆ©äºåˆ†æã€‚
*   æœ¬ç« é‡ç‚¹ä»‹ç»ç”¨äºæœ‰æ•ˆç»„åˆã€è¿æ¥å’Œé‡æ–°æ’åˆ—æ•°æ®çš„å·¥å…·ã€‚
*   å…³é”®æ¦‚å¿µï¼špandas ä¸­çš„**åˆ†å±‚ç´¢å¼•** (Hierarchical Indexing)ã€‚

## å¼•è¨€ï¼šæ•°æ®æ•´ç†å¯è§†åŒ–

![](./images/data_wrangling.png)

## æ•°æ®æ•´ç†ã€æ•°æ®æŒ–æ˜å’Œæœºå™¨å­¦ä¹ 

**ä»€ä¹ˆæ˜¯æ•°æ®æ•´ç†ï¼Ÿ**

*   **æ•°æ®æ•´ç†**ï¼ˆæˆ–æ•°æ®é‡æ•´ï¼‰æ˜¯å°†æ•°æ®ä»ä¸€ç§â€œåŸå§‹â€æ•°æ®å½¢å¼è½¬æ¢å’Œæ˜ å°„ä¸ºå¦ä¸€ç§æ ¼å¼çš„è¿‡ç¨‹ã€‚
*   ç›®çš„æ˜¯ä½¿å…¶æ›´é€‚åˆå’Œæœ‰ä»·å€¼åœ°ç”¨äºå„ç§ä¸‹æ¸¸ç›®çš„ï¼Œä¾‹å¦‚åˆ†æã€‚

## æ•°æ®æŒ–æ˜å’Œæœºå™¨å­¦ä¹ 

**ä»€ä¹ˆæ˜¯æ•°æ®æŒ–æ˜ï¼Ÿ**

*   **æ•°æ®æŒ–æ˜** æ˜¯åœ¨å¤§å‹æ•°æ®é›†ä¸­å‘ç°æ¨¡å¼ã€å¼‚å¸¸å’Œç›¸å…³æ€§ä»¥é¢„æµ‹ç»“æœçš„è¿‡ç¨‹ã€‚

**ä»€ä¹ˆæ˜¯æœºå™¨å­¦ä¹ ï¼Ÿ**

*   **æœºå™¨å­¦ä¹ ** æ˜¯äººå·¥æ™ºèƒ½çš„ä¸€ä¸ªå­é¢†åŸŸã€‚
*   å®ƒä¸“æ³¨äºå¼€å‘å¯ä»¥ä»æ•°æ®ä¸­å­¦ä¹ å¹¶æ ¹æ®æ•°æ®åšå‡ºå†³ç­–/é¢„æµ‹çš„ç³»ç»Ÿã€‚
*   **ç›‘ç£å­¦ä¹ **ï¼šä½¿ç”¨æ ‡è®°æ•°æ®é›†æ¥è®­ç»ƒç®—æ³•ã€‚
*   **æ— ç›‘ç£å­¦ä¹ **ï¼šåœ¨æœªæ ‡è®°æ•°æ®ä¸­å‘ç°éšè—æ¨¡å¼ã€‚
*   **å¼ºåŒ–å­¦ä¹ **ï¼šæ™ºèƒ½ä½“é€šè¿‡ä¸ç¯å¢ƒäº¤äº’æ¥å­¦ä¹ ã€‚

## Pandas ä¸­çš„åˆ†å±‚ç´¢å¼•

*   pandas çš„ä¸€é¡¹åŸºæœ¬åŠŸèƒ½ã€‚
*   å…è®¸åœ¨ä¸€ä¸ªè½´ä¸Šæ‹¥æœ‰*å¤šä¸ª*ï¼ˆä¸¤ä¸ªæˆ–æ›´å¤šï¼‰ç´¢å¼•çº§åˆ«ã€‚
*   å…è®¸ä»¥è¾ƒä½ç»´åº¦çš„å½¢å¼å¤„ç†è¾ƒé«˜ç»´åº¦çš„æ•°æ®ã€‚
*   **ç±»æ¯”ï¼š** å¯ä»¥æŠŠå®ƒæƒ³è±¡æˆåœ¨æ–‡ä»¶æŸœä¸­ï¼Œç±»åˆ«ä¸‹æœ‰å­ç±»åˆ«ã€‚ğŸ—„ï¸
*   **ä¼˜ç‚¹ï¼š** æä¾›äº†ä¸€ç§ç»“æ„åŒ–çš„æ–¹å¼æ¥è¡¨ç¤ºå’Œæ“ä½œå¤æ‚æ•°æ®é›†ã€‚

## åˆ†å±‚ç´¢å¼•ï¼šç¤ºä¾‹

```{python}
import pandas as pd  # å¯¼å…¥ pandas åº“ï¼Œå¹¶å°†å…¶ç®€ç§°ä¸º pd
import numpy as np   # å¯¼å…¥ numpy åº“ï¼Œå¹¶å°†å…¶ç®€ç§°ä¸º np

#| echo: true
data = pd.Series(np.random.uniform(size=9),  # åˆ›å»ºä¸€ä¸ªåŒ…å« 9 ä¸ªå‡åŒ€åˆ†å¸ƒéšæœºæ•°çš„ Series
                 index=[["a", "a", "a", "b", "b", "c", "c", "d", "d"],  # å¤–å±‚ç´¢å¼•
                        [1, 2, 3, 1, 3, 1, 2, 2, 3]])  # å†…å±‚ç´¢å¼•
data  # æ˜¾ç¤º Series
```

*   æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª `Series`ï¼Œå…¶ç´¢å¼•ä¸º*åˆ—è¡¨çš„åˆ—è¡¨*ã€‚
*   è¿™å°†åˆ›å»ºä¸€ä¸ª *MultiIndex* å¯¹è±¡ã€‚
*   ç´¢å¼•æ˜¾ç¤ºä¸­çš„â€œé—´éš™â€è¡¨ç¤ºâ€œä½¿ç”¨æ­£ä¸Šæ–¹çš„æ ‡ç­¾â€ã€‚

## ç†è§£ MultiIndex

```{python}
#| echo: true
data.index  # æ˜¾ç¤º Series çš„ç´¢å¼•
```

*   `MultiIndex` å¯¹è±¡è¡¨ç¤ºåˆ†å±‚ç´¢å¼•ã€‚
*   å®ƒåŒ…å« (å¤–å±‚, å†…å±‚) çš„å…ƒç»„ã€‚
*   è¿™é‡Œï¼š('a', 1), ('a', 2), ('a', 3), ('b', 1) ... è¡¨ç¤ºç´¢å¼•å¯¹ã€‚

## éƒ¨åˆ†ç´¢å¼•

æœ‰äº†åˆ†å±‚ç´¢å¼•ï¼Œå°±å¯ä»¥è¿›è¡Œ*éƒ¨åˆ†ç´¢å¼•*ã€‚ è¿™å…è®¸ç®€æ´åœ°é€‰æ‹©æ•°æ®å­é›†ã€‚

```{python}
#| echo: true
data["b"]  # é€‰æ‹©ç´¢å¼•ä¸º "b" çš„ç»„
```

## éƒ¨åˆ†ç´¢å¼•ï¼ˆç»­ï¼‰

```{python}
#| echo: true
data["b":"c"]  # é€‰æ‹©ä» "b" åˆ° "c" çš„ç»„ï¼ˆåŒ…æ‹¬ "b" å’Œ "c"ï¼‰
```

## éƒ¨åˆ†ç´¢å¼•ï¼ˆç»­ï¼‰

```{python}
#| echo: true
data.loc[["b", "d"]]  # é€‰æ‹©ç´¢å¼•ä¸º "b" å’Œ "d" çš„ç»„
```

## ä»å†…å±‚é€‰æ‹©

```{python}
#| echo: true
data.loc[:, 2]  # é€‰æ‹©å†…å±‚ç´¢å¼•ä¸º 2 çš„æ‰€æœ‰æ•°æ®
```

*   æˆ‘ä»¬ä½¿ç”¨ `.loc` è¿›è¡ŒåŸºäºæ ‡ç­¾çš„ç´¢å¼•ã€‚
*   `:` é€‰æ‹©æ‰€æœ‰å¤–å±‚ã€‚
*   `2` é€‰æ‹©å†…å±‚ç´¢å¼•ç­‰äº 2 çš„æ•°æ®ã€‚

## `unstack()` å’Œ `stack()`

*   `unstack()`: å°†æ•°æ®é‡å¡‘ä¸º DataFrameã€‚å®ƒå°†ï¼ˆè¡Œï¼‰ç´¢å¼•çš„ä¸€ä¸ªçº§åˆ«â€œé€è§†â€ä¸ºåˆ—æ ‡ç­¾ã€‚
*   `stack()`: `unstack()` çš„é€†æ“ä½œã€‚å®ƒå°†åˆ—æ ‡ç­¾é€è§†ä¸ºï¼ˆè¡Œï¼‰MultiIndex ä¸­çš„ä¸€ä¸ªçº§åˆ«ã€‚

## `unstack()` ç¤ºä¾‹

```{python}
#| echo: true
data.unstack()  # å°† Series è½¬æ¢ä¸º DataFrameï¼Œå†…å±‚ç´¢å¼•å˜ä¸ºåˆ—
```

## `stack()` ç¤ºä¾‹

```{python}
#| echo: true
data.unstack().stack()  # å°† DataFrame è½¬æ¢å› Seriesï¼Œåˆ—å˜å›å†…å±‚ç´¢å¼•
```

## DataFrame çš„åˆ†å±‚ç´¢å¼•

*   è¡Œå’Œåˆ—éƒ½å¯ä»¥æœ‰åˆ†å±‚ç´¢å¼•ã€‚

```{python}
#| echo: true
frame = pd.DataFrame(np.arange(12).reshape((4, 3)),  # åˆ›å»ºä¸€ä¸ª 4x3 çš„ DataFrameï¼Œå€¼ä¸º 0-11
                     index=[["a", "a", "b", "b"], [1, 2, 1, 2]],  # è¡Œç´¢å¼•ï¼šä¸¤å±‚
                     columns=[["Ohio", "Ohio", "Colorado"],  # åˆ—ç´¢å¼•ï¼šä¸¤å±‚
                              ["Green", "Red", "Green"]])
frame  # æ˜¾ç¤º DataFrame
```

*   è¿™é‡Œï¼Œè¡Œå’Œåˆ—éƒ½æœ‰ä¸¤ä¸ªçº§åˆ«ã€‚

## å‘½åç´¢å¼•çº§åˆ«

```{python}
#| echo: true
frame.index.names = ["key1", "key2"]  # è®¾ç½®è¡Œç´¢å¼•çš„åç§°
frame.columns.names = ["state", "color"]  # è®¾ç½®åˆ—ç´¢å¼•çš„åç§°
frame  # æ˜¾ç¤º DataFrame
```

*   ä¸ºç´¢å¼•çº§åˆ«å‘½åå¯ä»¥æé«˜å¯è¯»æ€§ã€‚
*   `frame.index.names` å’Œ `frame.columns.names` è®¾ç½®åç§°ã€‚

::: callout-note
è¯·æ³¨æ„ï¼Œç´¢å¼•åç§° "state" å’Œ "color" ä¸æ˜¯è¡Œæ ‡ç­¾ï¼ˆ`frame.index` å€¼ï¼‰çš„ä¸€éƒ¨åˆ†ã€‚
:::

## è®¿é—® `nlevels` å±æ€§
```{python}
#| echo: true
frame.index.nlevels #æŸ¥çœ‹è¡Œç´¢å¼•çš„å±‚æ•°
```
*   æ‚¨å¯ä»¥é€šè¿‡è®¿é—®ç´¢å¼•çš„ nlevels å±æ€§æ¥æŸ¥çœ‹ç´¢å¼•çš„å±‚æ•°ã€‚

## éƒ¨åˆ†åˆ—ç´¢å¼•

ç±»ä¼¼äºè¡Œç´¢å¼•ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€‰æ‹©åˆ—ç»„ï¼š

```{python}
#| echo: true
frame["Ohio"]  # é€‰æ‹©åˆ—ç´¢å¼•ä¸º "Ohio" çš„ç»„
```

## é‡æ–°æ’åºå’Œæ’åºçº§åˆ«

*   `swaplevel()`: äº¤æ¢ä¸¤ä¸ªçº§åˆ«ã€‚
*   `sort_index()`: ä½¿ç”¨ç´¢å¼•çº§åˆ«å¯¹æ•°æ®è¿›è¡Œæ’åºã€‚å¯ä»¥æŒ‰ç‰¹å®šçº§åˆ«æ’åºã€‚

## `swaplevel()` ç¤ºä¾‹

```{python}
#| echo: true
frame.swaplevel("key1", "key2")  # äº¤æ¢è¡Œç´¢å¼•çš„ "key1" å’Œ "key2" çº§åˆ«
```

## `sort_index()` ç¤ºä¾‹

```{python}
#| echo: true
frame.sort_index(level=1)  # æŒ‰è¡Œç´¢å¼•çš„ç¬¬ 1 çº§ï¼ˆkey2ï¼‰æ’åº
```

## `swaplevel()` å’Œ `sort_index()` ç»„åˆ

```{python}
#| echo: true
frame.swaplevel(0, 1).sort_index(level=0)  # å…ˆäº¤æ¢è¡Œç´¢å¼•çš„ 0 å’Œ 1 çº§ï¼Œç„¶åæŒ‰ç¬¬ 0 çº§æ’åº
```

::: callout-note
å¦‚æœç´¢å¼•ä»æœ€å¤–å±‚å¼€å§‹æŒ‰å­—å…¸é¡ºåºæ’åºï¼Œåˆ™å¯¹åˆ†å±‚ç´¢å¼•å¯¹è±¡è¿›è¡Œæ•°æ®é€‰æ‹©çš„æ€§èƒ½ä¼šæ›´å¥½ã€‚
:::

## æŒ‰çº§åˆ«è®¡ç®—æ±‡æ€»ç»Ÿè®¡

è®¸å¤šæè¿°æ€§å’Œæ±‡æ€»ç»Ÿè®¡éƒ½æœ‰ä¸€ä¸ª `level` é€‰é¡¹ï¼š

```{python}
#| echo: true
frame.groupby(level="key2").sum()  # æŒ‰è¡Œç´¢å¼•çš„ "key2" çº§åˆ«åˆ†ç»„ï¼Œå¹¶è®¡ç®—æ¯ç»„çš„å’Œ
```

## æŒ‰çº§åˆ«è®¡ç®—æ±‡æ€»ç»Ÿè®¡ï¼ˆåˆ—ç¤ºä¾‹ï¼‰

```{python}
#| echo: true
frame.groupby(level="color", axis="columns").sum()  # æŒ‰åˆ—ç´¢å¼•çš„ "color" çº§åˆ«åˆ†ç»„ï¼Œå¹¶è®¡ç®—æ¯ç»„çš„å’Œ
```

## ä½¿ç”¨ DataFrame çš„åˆ—è¿›è¡Œç´¢å¼•

*   `set_index()`: ä½¿ç”¨ä¸€ä¸ªæˆ–å¤šä¸ªåˆ—ä½œä¸ºç´¢å¼•åˆ›å»ºä¸€ä¸ªæ–°çš„ DataFrameã€‚
*   `reset_index()`: å°†åˆ†å±‚ç´¢å¼•çº§åˆ«ç§»åŠ¨åˆ°åˆ—ä¸­ï¼ˆä¸ `set_index()` ç›¸åï¼‰ã€‚

## ç¤ºä¾‹ DataFrame

```{python}
#| echo: true
frame = pd.DataFrame({"a": range(7),  # åˆ›å»ºä¸€ä¸ª DataFrameï¼Œåˆ— "a" çš„å€¼ä¸º 0-6
                      "b": range(7, 0, -1),  # åˆ— "b" çš„å€¼ä¸º 7-1
                      "c": ["one", "one", "one", "two", "two",
                            "two", "two"],  # åˆ— "c" çš„å€¼ä¸ºå­—ç¬¦ä¸²
                      "d": [0, 1, 2, 0, 1, 2, 3]})  # åˆ— "d" çš„å€¼ä¸º 0-3
frame  # æ˜¾ç¤º DataFrame
```

## `set_index()` ç¤ºä¾‹

```{python}
#| echo: true
frame2 = frame.set_index(["c", "d"])  # ä½¿ç”¨ "c" å’Œ "d" åˆ—ä½œä¸ºç´¢å¼•
frame2  # æ˜¾ç¤ºæ–°çš„ DataFrame
```

*   æˆ‘ä»¬ä½¿ç”¨ "c" å’Œ "d" åˆ—åˆ›å»ºä¸€ä¸ª MultiIndexã€‚
*   é»˜è®¤æƒ…å†µä¸‹ï¼Œç”¨äºç´¢å¼•çš„åˆ—ä¼šè¢«åˆ é™¤ã€‚ä½¿ç”¨ `drop=False` æ¥ä¿ç•™å®ƒä»¬ã€‚

## `set_index()` ä¸ `drop=False`

```{python}
#| echo: true
frame.set_index(["c", "d"], drop=False)  # ä½¿ç”¨ "c" å’Œ "d" åˆ—ä½œä¸ºç´¢å¼•ï¼Œå¹¶ä¿ç•™è¿™äº›åˆ—
```

## `reset_index()` ç¤ºä¾‹

```{python}
#| echo: true
frame2.reset_index()  # å°†åˆ†å±‚ç´¢å¼•ç§»åŠ¨åˆ°åˆ—ä¸­ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªé»˜è®¤çš„æ•´æ•°ç´¢å¼•
```

*   `reset_index()` å°†åˆ†å±‚ç´¢å¼•ç§»åŠ¨åˆ°åˆ—ä¸­ã€‚
*   å®ƒåˆ›å»ºä¸€ä¸ªé»˜è®¤çš„æ•´æ•°ç´¢å¼•ã€‚

## åˆå¹¶å’Œæ‹¼æ¥æ•°æ®é›†

åœ¨ pandas ä¸­åˆå¹¶æ•°æ®çš„ä¸»è¦ä¸‰ç§æ–¹æ³•ï¼š

1.  `pandas.merge`: åŸºäº*é”®*ï¼ˆç±»ä¼¼äº SQL è¿æ¥ï¼‰è¿æ¥ DataFrame ä¸­çš„è¡Œã€‚
2.  `pandas.concat`: æ²¿ç€è½´è¿æ¥æˆ–â€œå †å â€å¯¹è±¡ã€‚
3.  `combine_first`: æ‹¼æ¥é‡å æ•°æ®ï¼ˆå¡«å……ç¼ºå¤±å€¼ï¼‰ã€‚

## æ•°æ®åº“é£æ ¼çš„ DataFrame è¿æ¥

*   `pandas.merge` æ˜¯è¿æ¥æ“ä½œçš„ä¸»è¦å‡½æ•°ã€‚
*   ç±»ä¼¼äº SQL è¿æ¥ã€‚
*   å…³é”®æ¦‚å¿µï¼š*é”®*ï¼ˆç”¨äºé“¾æ¥è¡Œçš„åˆ—ï¼‰ã€‚

## `pandas.merge`: å¤šå¯¹ä¸€è¿æ¥ï¼ˆè®¾ç½®ï¼‰

```{python}
#| echo: true
df1 = pd.DataFrame({"key": ["b", "b", "a", "c", "a", "a", "b"],  # DataFrame 1ï¼ŒåŒ…å« "key" åˆ—
                    "data1": pd.Series(range(7), dtype="Int64")})  # å’Œ "data1" åˆ—
df2 = pd.DataFrame({"key": ["a", "b", "d"],  # DataFrame 2ï¼ŒåŒ…å« "key" åˆ—
                    "data2": pd.Series(range(3), dtype="Int64")})  # å’Œ "data2" åˆ—
```

```{python}
#| echo: true
df1  # æ˜¾ç¤º df1
```

```{python}
#| echo: true
df2  # æ˜¾ç¤º df2
```

## `pandas.merge`: å¤šå¯¹ä¸€è¿æ¥ï¼ˆç¤ºä¾‹ï¼‰

```{python}
#| echo: true
pd.merge(df1, df2)  # åˆå¹¶ df1 å’Œ df2ï¼Œè‡ªåŠ¨ä½¿ç”¨ "key" åˆ—ä½œä¸ºè¿æ¥é”®
# æˆ–è€… pd.merge(df1, df2, on="key")  # æ˜¾å¼æŒ‡å®šè¿æ¥é”®ä¸º "key"
```

*   `df1` æœ‰å¤šè¡Œæ ‡è®°ä¸º 'a' å’Œ 'b'ã€‚
*   `df2` åœ¨ 'key' åˆ—ä¸­æ¯ä¸ªå€¼åªæœ‰ä¸€è¡Œã€‚
*   å¦‚æœæœªæŒ‡å®šè¿æ¥åˆ—ï¼Œ`merge` å°†ä½¿ç”¨é‡å çš„åˆ—åã€‚æœ€ä½³åšæ³•æ˜¯æ˜¾å¼æŒ‡å®šã€‚

## `pandas.merge`: ä¸åŒçš„åˆ—å

å¦‚æœåˆ—åä¸åŒï¼Œè¯·åˆ†åˆ«æŒ‡å®šå®ƒä»¬ï¼š

```{python}
#| echo: true
df3 = pd.DataFrame({"lkey": ["b", "b", "a", "c", "a", "a", "b"],  # DataFrame 3ï¼ŒåŒ…å« "lkey" åˆ—
                    "data1": pd.Series(range(7), dtype="Int64")})  # å’Œ "data1" åˆ—
df4 = pd.DataFrame({"rkey": ["a", "b", "d"],  # DataFrame 4ï¼ŒåŒ…å« "rkey" åˆ—
                    "data2": pd.Series(range(3), dtype="Int64")})  # å’Œ "data2" åˆ—
pd.merge(df3, df4, left_on="lkey", right_on="rkey")  # ä½¿ç”¨ "lkey" å’Œ "rkey" ä½œä¸ºè¿æ¥é”®
```

*   `left_on`: å·¦ä¾§ DataFrame ä¸­çš„åˆ—ã€‚
*   `right_on`: å³ä¾§ DataFrame ä¸­çš„åˆ—ã€‚

## `pandas.merge`: è¿æ¥ç±»å‹

*   é»˜è®¤æƒ…å†µä¸‹ï¼Œ`merge` æ‰§è¡Œ "inner" è¿æ¥ï¼ˆé”®çš„äº¤é›†ï¼‰ã€‚
*   å…¶ä»–è¿æ¥ç±»å‹ï¼š"left", "right", "outer"ã€‚

## `pandas.merge`: å¤–è¿æ¥ç¤ºä¾‹

```{python}
#| echo: true
pd.merge(df1, df2, how="outer")  # æ‰§è¡Œå¤–è¿æ¥ï¼ŒåŒ…å«æ‰€æœ‰é”®
```

*   **å¤–è¿æ¥ï¼š** é”®çš„å¹¶é›†ã€‚
*   **å·¦è¿æ¥ï¼š** å·¦ä¾§ DataFrame ä¸­çš„æ‰€æœ‰é”®ã€‚
*   **å³è¿æ¥ï¼š** å³ä¾§ DataFrame ä¸­çš„æ‰€æœ‰é”®ã€‚

## ä½¿ç”¨ `how` å‚æ•°çš„è¿æ¥ç±»å‹

| é€‰é¡¹        | è¡Œä¸º                                                       |
| :------------ | :------------------------------------------------------------- |
| `how="inner"` | ä»…ä½¿ç”¨ä¸¤ä¸ªè¡¨ä¸­éƒ½å­˜åœ¨çš„é”®ç»„åˆ          |
| `how="left"`  | ä½¿ç”¨å·¦ä¾§è¡¨ä¸­çš„æ‰€æœ‰é”®ç»„åˆ               |
| `how="right"` | ä½¿ç”¨å³ä¾§è¡¨ä¸­çš„æ‰€æœ‰é”®ç»„åˆ              |
| `how="outer"` | ä½¿ç”¨ä¸¤ä¸ªè¡¨ä¸­*ä¸€èµ·*å­˜åœ¨çš„æ‰€æœ‰é”®ç»„åˆ    |

## `pandas.merge`: å¤šå¯¹å¤šè¿æ¥

*   å¤šå¯¹å¤šè¿æ¥å½¢æˆåŒ¹é…é”®çš„*ç¬›å¡å°”ç§¯*ã€‚

```{python}
#| echo: true
df1 = pd.DataFrame({"key": ["b", "b", "a", "c", "a", "b"],  # DataFrame 1
                    "data1": pd.Series(range(6), dtype="Int64")})
df2 = pd.DataFrame({"key": ["a", "b", "a", "b", "d"],  # DataFrame 2
                    "data2": pd.Series(range(5), dtype="Int64")})

pd.merge(df1, df2, on="key", how="left")  # å·¦è¿æ¥
```

*   `df1` ä¸­æœ‰ä¸‰ä¸ª "b" è¡Œï¼Œ`df2` ä¸­æœ‰ä¸¤ä¸ªï¼Œå› æ­¤ç»“æœä¸­æœ‰å…­ä¸ª "b" è¡Œã€‚

## ä½¿ç”¨å¤šä¸ªé”®åˆå¹¶

ä¼ é€’ä¸€ä¸ªåˆ—ååˆ—è¡¨ï¼š

```{python}
#| echo: true
left = pd.DataFrame({"key1": ["foo", "foo", "bar"],  # å·¦ä¾§ DataFrame
                     "key2": ["one", "two", "one"],
                     "lval": pd.Series([1, 2, 3], dtype='Int64')})
right = pd.DataFrame({"key1": ["foo", "foo", "bar", "bar"],  # å³ä¾§ DataFrame
                      "key2": ["one", "one", "one", "two"],
                      "rval": pd.Series([4, 5, 6, 7], dtype='Int64')})
pd.merge(left, right, on=["key1", "key2"], how="outer")  # ä½¿ç”¨ "key1" å’Œ "key2" ä½œä¸ºè¿æ¥é”®ï¼Œæ‰§è¡Œå¤–è¿æ¥
```

*   å¯ä»¥å°†å¤šä¸ªé”®è§†ä¸ºå½¢æˆç”¨ä½œå•ä¸ªè¿æ¥é”®çš„å…ƒç»„ã€‚

## é‡å çš„åˆ—å

*   `merge` æœ‰ä¸€ä¸ª `suffixes` é€‰é¡¹æ¥å¤„ç†é‡å çš„åˆ—åã€‚

```{python}
#| echo: true
pd.merge(left, right, on="key1")  # è‡ªåŠ¨æ·»åŠ åç¼€ "_x" å’Œ "_y"
```

## é‡å çš„åˆ—åï¼š`suffixes`

```{python}
#| echo: true
pd.merge(left, right, on="key1", suffixes=("_left", "_right"))  # è‡ªå®šä¹‰åç¼€
```

## `pandas.merge` å‡½æ•°å‚æ•°

| å‚æ•°         | æè¿°                                                                                                                   |
| :----------- | :---------------------------------------------------------------------------------------------------------------------------- |
| `left`       | å·¦ä¾§è¦åˆå¹¶çš„ DataFrameã€‚                                                                                      |
| `right`      | å³ä¾§è¦åˆå¹¶çš„ DataFrameã€‚                                                                                     |
| `how`        | è¿æ¥ç±»å‹ï¼š"inner", "outer", "left", æˆ– "right"ï¼ˆé»˜è®¤ä¸º "inner"ï¼‰ã€‚                                                   |
| `on`         | è¦è¿æ¥çš„åˆ—åï¼ˆå¿…é¡»åœ¨ä¸¤ä¸ª DataFrame ä¸­éƒ½å­˜åœ¨ï¼‰ã€‚                                                                           |
| `left_on`    | å·¦ä¾§ DataFrame ä¸­ç”¨ä½œè¿æ¥é”®çš„åˆ—ã€‚                                                                               |
| `right_on`   | ç±»ä¼¼äº `left_on`ï¼Œç”¨äºå³ä¾§ DataFrameã€‚                                                                             |
| `left_index` | ä½¿ç”¨å·¦ä¾§ DataFrame çš„è¡Œç´¢å¼•ä½œä¸ºå…¶è¿æ¥é”®ã€‚                                                                                     |
| `right_index`| ç±»ä¼¼äº `left_index`ã€‚                                                                                                    |
| `sort`       | æŒ‰è¿æ¥é”®å¯¹åˆå¹¶åçš„æ•°æ®è¿›è¡Œå­—å…¸æ’åºï¼ˆé»˜è®¤ä¸º Falseï¼‰ã€‚                                                             |
| `suffixes`   | è¦é™„åŠ åˆ°é‡å åˆ—åçš„å­—ç¬¦ä¸²å…ƒç»„ï¼ˆé»˜è®¤ä¸º ("\_x", "\_y")ï¼‰ã€‚                                         |
| `copy`       | å¦‚æœä¸º Falseï¼Œåˆ™åœ¨æŸäº›æƒ…å†µä¸‹é¿å…å¤åˆ¶æ•°æ®ï¼ˆé»˜è®¤ä¸ºå¤åˆ¶ï¼‰ã€‚                                                                |
|  `validate`     |   æ£€æŸ¥åˆå¹¶çš„ç±»å‹ï¼ˆä¸€å¯¹ä¸€ï¼Œä¸€å¯¹å¤šï¼Œå¤šå¯¹å¤šï¼‰                                     |
| `indicator`  | æ·»åŠ åä¸º `_merge` çš„åˆ—ï¼ŒæŒ‡ç¤ºæ¯è¡Œçš„æ¥æºï¼ˆ"left_only", "right_only", "both"ï¼‰ã€‚                |

## åŸºäºç´¢å¼•åˆå¹¶

*   ä½¿ç”¨ `left_index=True` æˆ– `right_index=True`ï¼ˆæˆ–ä¸¤è€…ï¼‰æ¥åŸºäºç´¢å¼•åˆå¹¶ã€‚

```{python}
#| echo: true
left1 = pd.DataFrame({"key": ["a", "b", "a", "a", "b", "c"],  # å·¦ä¾§ DataFrame
                      "value": pd.Series(range(6), dtype="Int64")})
right1 = pd.DataFrame({"group_val": [3.5, 7]}, index=["a", "b"])  # å³ä¾§ DataFrameï¼Œä½¿ç”¨ç´¢å¼•

pd.merge(left1, right1, left_on="key", right_index=True)  # å°† left1 çš„ "key" åˆ—ä¸ right1 çš„ç´¢å¼•åˆå¹¶
```

*   æˆ‘ä»¬å°† `left1` çš„ "key" åˆ—ä¸ `right1` çš„ç´¢å¼•åˆå¹¶ã€‚
*   `left1`çš„ç´¢å¼•ä¼šè¢«ä¿ç•™ã€‚

## åˆ†å±‚ç´¢å¼•ï¼šå¤šé”®åˆå¹¶

å¯¹äºåˆ†å±‚ç´¢å¼•ï¼ŒåŸºäºç´¢å¼•è¿æ¥ç±»ä¼¼äºå¤šé”®åˆå¹¶ï¼š

```{python}
#| echo: true
lefth = pd.DataFrame({"key1": ["Ohio", "Ohio", "Ohio",
                            "Nevada", "Nevada"],  # å·¦ä¾§ DataFrame
                    "key2": [2000, 2001, 2002, 2001, 2002],
                    "data": pd.Series(range(5), dtype="Int64")})
righth_index = pd.MultiIndex.from_arrays([  # å³ä¾§ DataFrame çš„ MultiIndex
    ["Nevada", "Nevada", "Ohio", "Ohio", "Ohio", "Ohio"],
    [2001, 2000, 2000, 2000, 2001, 2002]
    ])
righth = pd.DataFrame({"event1": pd.Series([0, 2, 4, 6, 8, 10], dtype="Int64",
                                        index=righth_index),  # ä½¿ç”¨ MultiIndex
                    "event2": pd.Series([1, 3, 5, 7, 9, 11], dtype="Int64",
                                        index=righth_index)})

pd.merge(lefth, righth, left_on=["key1", "key2"], right_index=True, how="outer")  # åŸºäºå¤šä¸ªåˆ—å’Œç´¢å¼•åˆå¹¶
```

## DataFrame çš„ `join` æ–¹æ³•

*   ç®€åŒ–äº†åŸºäºç´¢å¼•çš„åˆå¹¶ã€‚
*   é»˜è®¤æ‰§è¡Œ*å·¦è¿æ¥*ã€‚

```{python}
#| echo: true
left2 = pd.DataFrame([[1., 2.], [3., 4.], [5., 6.]],
                     index=["a", "c", "e"],  # å·¦ä¾§ DataFrame
                     columns=["Ohio", "Nevada"]).astype("Int64")
right2 = pd.DataFrame([[7., 8.], [9., 10.], [11., 12.], [13, 14]],
                      index=["b", "c", "d", "e"],  # å³ä¾§ DataFrame
                      columns=["Missouri", "Alabama"]).astype("Int64")
left2.join(right2, how="outer")  # åŸºäºç´¢å¼•è¿æ¥
```

*   å¯ä»¥åŸºäºè°ƒç”¨ DataFrame çš„å…¶ä¸­ä¸€åˆ—è¿›è¡Œè¿æ¥ã€‚
*   æ”¯æŒè¿æ¥å…·æœ‰ç›¸ä¼¼ç´¢å¼•ä½†åˆ—ä¸é‡å çš„å¤šä¸ª DataFrameã€‚

## `join` åŸºäºåˆ—

```{python}
#| echo: true
left1.join(right1, on="key")  # å°† left1 ä¸ right1 åŸºäº left1 çš„ "key" åˆ—è¿æ¥
```

## æ²¿è½´è¿æ¥

*   `numpy.concatenate`: é€‚ç”¨äº NumPy æ•°ç»„ã€‚

```{python}
#| echo: true
arr = np.arange(12).reshape((3, 4))  # åˆ›å»ºä¸€ä¸ª 3x4 çš„æ•°ç»„
np.concatenate([arr, arr], axis=1)  # æ²¿ç€åˆ—è¿æ¥
```

*   `pandas.concat`: è§£å†³ä»¥ä¸‹é—®é¢˜ï¼š
    *   å¤„ç†ä¸åŒçš„ç´¢å¼•ã€‚
    *   è¯†åˆ«è¿æ¥çš„å—ã€‚
    *   ä¿ç•™æ•°æ®ã€‚

## `pandas.concat` ä¸ Series

```{python}
#| echo: true
s1 = pd.Series([0, 1], index=["a", "b"], dtype="Int64")  # Series 1
s2 = pd.Series([2, 3, 4], index=["c", "d", "e"], dtype="Int64")  # Series 2
s3 = pd.Series([5, 6], index=["f", "g"], dtype="Int64")  # Series 3
pd.concat([s1, s2, s3])  # æ²¿ç€è¡Œè¿æ¥ Series
```

*   é»˜è®¤æƒ…å†µä¸‹ï¼Œ`concat` æ²¿ç€ `axis="index"`ï¼ˆè¡Œï¼‰å·¥ä½œï¼Œç”Ÿæˆå¦ä¸€ä¸ª Seriesã€‚
*   å°†å€¼å’Œç´¢å¼•ç²˜åˆåœ¨ä¸€èµ·ã€‚

## `pandas.concat`: `axis="columns"`

```{python}
#| echo: true
pd.concat([s1, s2, s3], axis="columns")  # æ²¿ç€åˆ—è¿æ¥ Seriesï¼Œç”Ÿæˆ DataFrame
```

*   `axis="columns"` ç”Ÿæˆä¸€ä¸ª DataFrameã€‚
*   ç»“æœæ˜¯ç´¢å¼•çš„*å¹¶é›†*ï¼ˆå¤–è¿æ¥ï¼‰ã€‚

## `pandas.concat`: `join="inner"`

```{python}
#| echo: true
s4 = pd.concat([s1, s3])  # è¿æ¥ s1 å’Œ s3
pd.concat([s1, s4], axis="columns", join="inner")  # æ²¿ç€åˆ—è¿æ¥ s1 å’Œ s4ï¼Œæ‰§è¡Œå†…è¿æ¥
```

*   `join="inner"` å¯¹ç´¢å¼•æ‰§è¡Œäº¤é›†ã€‚

## `pandas.concat`: `keys` å‚æ•°

```{python}
#| echo: true
result = pd.concat([s1, s1, s3], keys=["one", "two", "three"])  # è¿æ¥å¹¶åˆ›å»ºåˆ†å±‚ç´¢å¼•
result  # æ˜¾ç¤ºç»“æœ
```

## `unstack()` ç»“æœ

```{python}
#| echo: true
result.unstack()  # å°†ç»“æœè½¬æ¢ä¸º DataFrame
```

*   `keys` åˆ›å»ºä¸€ä¸ªåˆ†å±‚ç´¢å¼•ã€‚æ ‡è¯†è¿æ¥çš„å—ã€‚
*   å½“æ²¿ç€ `axis="columns"` è¿æ¥æ—¶ï¼Œ`keys` æˆä¸º DataFrame åˆ—æ ‡é¢˜ã€‚

## `pandas.concat` ä¸ DataFrame

é€»è¾‘ä¸ Series ç›¸åŒï¼š

```{python}
#| echo: true
df1 = pd.DataFrame(np.arange(6).reshape(3, 2), index=["a", "b", "c"],  # DataFrame 1
                   columns=["one", "two"])
df2 = pd.DataFrame(5 + np.arange(4).reshape(2, 2), index=["a", "c"],  # DataFrame 2
                   columns=["three", "four"])
pd.concat([df1, df2], axis="columns", keys=["level1", "level2"])  # æ²¿ç€åˆ—è¿æ¥ï¼Œå¹¶ä½¿ç”¨ keys ä½œä¸ºåˆ—æ ‡é¢˜
```

*   æ‚¨å¯ä»¥ä½¿ç”¨ `names` å‚æ•°å‘½ååˆ›å»ºçš„è½´çº§åˆ«ã€‚
*   å¦‚æœè¡Œç´¢å¼•ä¸åŒ…å«ç›¸å…³æ•°æ®ï¼Œè¯·ä½¿ç”¨ `ignore_index=True`ã€‚

## `pandas.concat` å‡½æ•°å‚æ•°

| å‚æ•°          | æè¿°                                                                                                                                                                                                                |
| :---------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `objs`            | è¦è¿æ¥çš„ pandas å¯¹è±¡åˆ—è¡¨æˆ–å­—å…¸ï¼ˆå¿…éœ€ï¼‰ã€‚                                                                                                                                                          |
| `axis`            | è¦è¿æ¥çš„è½´ï¼ˆé»˜è®¤ä¸º "index"ï¼‰ã€‚                                                                                                                                                                             |
| `join`           | "inner" æˆ– "outer"ï¼ˆé»˜è®¤ä¸º "outer"ï¼‰ã€‚                                                                                                                                                                                   |
| `keys`           | ä¸è¦è¿æ¥çš„å¯¹è±¡å…³è”çš„å€¼ï¼Œå½¢æˆä¸€ä¸ªåˆ†å±‚ç´¢å¼•ã€‚                                                                                                                                                            |
| `levels`          | ç”¨ä½œåˆ†å±‚ç´¢å¼•çº§åˆ«çš„ç‰¹å®šç´¢å¼•ã€‚                                                                                                                                                                   |
| `names`           | åˆ›å»ºçš„åˆ†å±‚çº§åˆ«çš„åç§°ã€‚                                                                                                                                                                                      |
| `verify_integrity`| æ£€æŸ¥æ–°è½´æ˜¯å¦æœ‰é‡å¤é¡¹ï¼Œå¦‚æœæœ‰åˆ™å¼•å‘å¼‚å¸¸ï¼ˆé»˜è®¤ä¸º Falseï¼‰ã€‚                                                                                                                                                 |
| `ignore_index`    | ä¸ä¿ç•™ç´¢å¼•ï¼›ç”Ÿæˆä¸€ä¸ªæ–°çš„ `range(total_length)` ç´¢å¼•ã€‚                                                                                                                             |

## åˆå¹¶é‡å æ•°æ®

*   `numpy.where`: æ‰§è¡Œé¢å‘æ•°ç»„çš„ if-else æ“ä½œã€‚

```{python}
#| echo: true
a = pd.Series([np.nan, 2.5, 0.0, 3.5, 4.5, np.nan],  # Series aï¼ŒåŒ…å« NaN å€¼
              index=["f", "e", "d", "c", "b", "a"])
b = pd.Series([0., np.nan, 2., np.nan, np.nan, 5.],  # Series bï¼ŒåŒ…å« NaN å€¼
              index=["a", "b", "c", "d", "e", "f"])
np.where(pd.isna(a), b, a)  # å¦‚æœ a ä¸­æœ‰ NaNï¼Œåˆ™ä½¿ç”¨ b ä¸­çš„å€¼ï¼Œå¦åˆ™ä½¿ç”¨ a ä¸­çš„å€¼
```

## `Series.combine_first`

*   `Series.combine_first`: æŒ‰ç´¢å¼•å¯¹é½å€¼å¹¶â€œä¿®è¡¥â€ç¼ºå¤±æ•°æ®ã€‚

```{python}
#| echo: true
a.combine_first(b)  # ä½¿ç”¨ b ä¸­çš„å€¼å¡«å…… a ä¸­çš„ NaN å€¼ï¼ŒæŒ‰ç´¢å¼•å¯¹é½
```

*   `combine_first` æŒ‰ç´¢å¼•å¯¹é½ï¼ˆä¸ `np.where` ä¸åŒï¼‰ã€‚

## `combine_first` ä¸ DataFrame

*   `combine_first` é€åˆ—å·¥ä½œã€‚
*   å®ƒä½¿ç”¨ä¼ é€’å¯¹è±¡ä¸­çš„æ•°æ®â€œä¿®è¡¥â€è°ƒç”¨å¯¹è±¡ä¸­çš„ç¼ºå¤±æ•°æ®ã€‚

```{python}
#| echo: true
df1 = pd.DataFrame({"a": [1., np.nan, 5., np.nan],  # DataFrame 1ï¼ŒåŒ…å« NaN å€¼
                    "b": [np.nan, 2., np.nan, 6.],
                    "c": range(2, 18, 4)})
df2 = pd.DataFrame({"a": [5., 4., np.nan, 3., 7.],  # DataFrame 2ï¼ŒåŒ…å« NaN å€¼
                    "b": [np.nan, 3., 4., 6., 8.]})
df1.combine_first(df2)  # ä½¿ç”¨ df2 ä¸­çš„å€¼å¡«å…… df1 ä¸­çš„ NaN å€¼ï¼Œé€åˆ—è¿›è¡Œ
```

## é‡å¡‘å’Œé€è§†

*   **é‡å¡‘/é€è§†æ“ä½œï¼š** é‡æ–°æ’åˆ—è¡¨æ ¼æ•°æ®ã€‚
*   **åˆ†å±‚ç´¢å¼•** æä¾›äº†ä¸€ç§ä¸€è‡´çš„æ–¹å¼æ¥é‡å¡‘ã€‚
*   **ä¸¤ä¸ªä¸»è¦æ“ä½œï¼š**
    *   `stack`: å°†åˆ—â€œæ—‹è½¬â€æˆ–é€è§†åˆ°è¡Œã€‚
    *   `unstack`: å°†è¡Œé€è§†åˆ°åˆ—ã€‚

## `stack` å’Œ `unstack`: ç¤ºä¾‹ DataFrame

```{python}
#| echo: true
data = pd.DataFrame(np.arange(6).reshape((2, 3)),  # åˆ›å»ºä¸€ä¸ª 2x3 çš„ DataFrame
                    index=pd.Index(["Ohio", "Colorado"], name="state"),  # è¡Œç´¢å¼•ï¼Œåä¸º "state"
                    columns=pd.Index(["one", "two", "three"],
                    name="number"))  # åˆ—ç´¢å¼•ï¼Œåä¸º "number"
data  # æ˜¾ç¤º DataFrame
```

## `stack` ç¤ºä¾‹

```{python}
#| echo: true
result = data.stack()  # å°† DataFrame è½¬æ¢ä¸º Seriesï¼Œåˆ—ç´¢å¼•å˜ä¸ºå†…å±‚è¡Œç´¢å¼•
result  # æ˜¾ç¤º Series
```

## `unstack` ç¤ºä¾‹

```{python}
#| echo: true
result.unstack()  # å°† Series è½¬æ¢å› DataFrameï¼Œå†…å±‚è¡Œç´¢å¼•å˜ä¸ºåˆ—ç´¢å¼•
```

## `unstack` ä¸ä¸åŒçš„çº§åˆ«

*   é»˜è®¤æƒ…å†µä¸‹ï¼Œæœ€å†…å±‚è¢« unstackedã€‚
*   é€šè¿‡æ•°å­—æˆ–åç§°æŒ‡å®šä¸åŒçš„çº§åˆ«ã€‚

```{python}
#| echo: true
result.unstack(level=0)  # å°†å¤–å±‚è¡Œç´¢å¼•ï¼ˆ"state"ï¼‰unstack åˆ°åˆ—
# æˆ– result.unstack("state")  # ä½¿ç”¨åç§°æŒ‡å®šè¦ unstack çš„çº§åˆ«
```

*   Unstacking å¯èƒ½ä¼šå¼•å…¥ç¼ºå¤±æ•°æ®ã€‚
*   Stacking é»˜è®¤ä¼šè¿‡æ»¤æ‰ç¼ºå¤±æ•°æ®ã€‚

## Stacking ä¸ `dropna=False`

```{python}
#| echo: true
s1 = pd.Series([0, 1, 2, 3], index=["a", "b", "c", "d"], dtype="Int64")  # Series 1
s2 = pd.Series([4, 5, 6], index=["c", "d", "e"], dtype="Int64")  # Series 2
data2 = pd.concat([s1, s2], keys=["one", "two"])  # è¿æ¥ s1 å’Œ s2ï¼Œå¹¶åˆ›å»ºåˆ†å±‚ç´¢å¼•
data2.unstack().stack(dropna=False)  # å…ˆ unstackï¼Œå† stackï¼Œå¹¶ä¿ç•™ NaN å€¼
```

## DataFrame ä¸­çš„ `unstack`

åœ¨ DataFrame ä¸­ unstacking æ—¶ï¼Œunstacked çš„çº§åˆ«å°†æˆä¸º*æœ€ä½*çº§åˆ«ã€‚

```{python}
#| echo: true
df = pd.DataFrame({"left": result, "right": result + 5},  # åˆ›å»ºä¸€ä¸ª DataFrame
                  columns=pd.Index(["left", "right"], name="side"))  # åˆ—ç´¢å¼•ï¼Œåä¸º "side"
df  # æ˜¾ç¤º DataFrame
```

## `unstack` å’Œ `stack` ç¤ºä¾‹

```{python}
#| echo: true
df.unstack(level="state").stack(level="side")  # å…ˆæŒ‰ "state" çº§åˆ« unstackï¼Œå†æŒ‰ "side" çº§åˆ« stack
```

## å°†â€œé•¿â€æ ¼å¼é€è§†ä¸ºâ€œå®½â€æ ¼å¼

*   **é•¿/å †å æ ¼å¼ï¼š** å¸¸ç”¨äºå­˜å‚¨å¤šä¸ªæ—¶é—´åºåˆ—ã€‚æ¯è¡Œæ˜¯ä¸€ä¸ªè§‚å¯Ÿå€¼ã€‚
*   **å®½æ ¼å¼ï¼š** æ¯ä¸ªå˜é‡éƒ½æœ‰è‡ªå·±çš„åˆ—ã€‚

## ç¤ºä¾‹ï¼šé•¿æ ¼å¼æ•°æ®

```{python}
#| echo: true
data = pd.read_csv("examples/macrodata.csv")  # ä» CSV æ–‡ä»¶è¯»å–æ•°æ®
data = data.loc[:, ["year", "quarter", "realgdp", "infl", "unemp"]]  # é€‰æ‹©ç‰¹å®šçš„åˆ—
periods = pd.PeriodIndex(year=data.pop("year"),  # åˆ›å»ºä¸€ä¸ª PeriodIndex
                        quarter=data.pop("quarter"),
                        name="date")
data.index = periods.to_timestamp("D")  # å°† PeriodIndex è½¬æ¢ä¸º Timestampï¼Œå¹¶è®¾ç½®ä¸ºç´¢å¼•
data = data.reindex(columns=["realgdp", "infl", "unemp"])  # é‡æ–°è®¾ç½®åˆ—çš„é¡ºåº
data.columns.name = "item"  # è®¾ç½®åˆ—ç´¢å¼•çš„åç§°
long_data = (data.stack()  # å°† DataFrame è½¬æ¢ä¸º Series
                .reset_index()  # é‡ç½®ç´¢å¼•
                .rename(columns={0: "value"}))  # é‡å‘½ååˆ—
long_data[:10]  # æ˜¾ç¤ºå‰ 10 è¡Œ
```

## `pivot` æ–¹æ³•

`pivot` æ–¹æ³•å°†é•¿æ ¼å¼è½¬æ¢ä¸ºå®½æ ¼å¼ã€‚

```{python}
#| echo: true
pivoted = long_data.pivot(index="date", columns="item",
                          values="value")  # å°†é•¿æ ¼å¼æ•°æ®é€è§†ä¸ºå®½æ ¼å¼
pivoted.head()  # æ˜¾ç¤ºå‰å‡ è¡Œ
```

*   `index`: ç”¨ä½œè¡Œç´¢å¼•çš„åˆ—ã€‚
*   `columns`: ç”¨äºåˆ›å»ºæ–°åˆ—çš„åˆ—ã€‚
*   `values`: ç”¨äºå¡«å…… DataFrame çš„åˆ—ã€‚

## ä½¿ç”¨å¤šä¸ªå€¼åˆ—è¿›è¡Œé€è§†

```{python}
#| echo: true
long_data["value2"] = np.random.standard_normal(len(long_data))  # æ·»åŠ ä¸€ä¸ªæ–°çš„å€¼åˆ—
pivoted = long_data.pivot(index="date", columns="item")  # é€è§†ï¼Œä¸æŒ‡å®š values å‚æ•°
pivoted.head()  # æ˜¾ç¤ºå‰å‡ è¡Œï¼Œç°åœ¨æœ‰åˆ†å±‚åˆ—
```

*   å¦‚æœçœç•¥ `values` å‚æ•°ï¼Œåˆ™ä¼šå¾—åˆ°åˆ†å±‚åˆ—ã€‚

## `pivot` ç­‰ä»·äº...

`pivot` ç­‰ä»·äºä½¿ç”¨ `set_index` åè·Ÿ `unstack`ï¼š

```{python}
#| echo: true
unstacked = long_data.set_index(["date", "item"]).unstack(level="item")  # å…ˆè®¾ç½®ç´¢å¼•ï¼Œå† unstack
unstacked.head()  # æ˜¾ç¤ºå‰å‡ è¡Œ
```

## å°†â€œå®½â€æ ¼å¼é€è§†ä¸ºâ€œé•¿â€æ ¼å¼

*   `pandas.melt`: `pivot` çš„é€†æ“ä½œã€‚å°†å¤šåˆ—åˆå¹¶ä¸ºä¸€åˆ—ï¼ˆæ›´é•¿çš„ DataFrameï¼‰ã€‚

```{python}
#| echo: true
df = pd.DataFrame({"key": ["foo", "bar", "baz"],  # åˆ›å»ºä¸€ä¸ª DataFrame
                   "A": [1, 2, 3],
                   "B": [4, 5, 6],
                   "C": [7, 8, 9]})
melted = pd.melt(df, id_vars="key")  # å°† DataFrame ä»å®½æ ¼å¼è½¬æ¢ä¸ºé•¿æ ¼å¼
melted  # æ˜¾ç¤ºç»“æœ
```

*   `id_vars`: ç»„æŒ‡ç¤ºå™¨åˆ—ã€‚
*   `value_vars`: è¦â€œå–æ¶ˆé€è§†â€çš„åˆ—ã€‚å¦‚æœæœªæŒ‡å®šï¼Œåˆ™ä½¿ç”¨æ‰€æœ‰å…¶ä»–åˆ—ã€‚

## `pandas.melt` ç¤ºä¾‹

```{python}
#| echo: true
pd.melt(df, id_vars="key", value_vars=["A", "B"])  # æŒ‡å®šè¦å–æ¶ˆé€è§†çš„åˆ—
```

```{python}
#| echo: true
pd.melt(df, value_vars=["A", "B", "C"])  # ä¸æŒ‡å®šç»„æŒ‡ç¤ºå™¨åˆ—
```


```{python}
#| echo: true
pd.melt(df, value_vars=["key", "A", "B"])  # `value_vars` ä¹Ÿå¯ä»¥åŒ…å«ç»„æ ‡è¯†ç¬¦
```

*   å¯ä»¥ä¸ä½¿ç”¨ä»»ä½•ç»„æ ‡è¯†ç¬¦ã€‚

## ä½¿ç”¨ `melt` å’Œ `pivot` é‡å¡‘

```{python}
#| echo: true
reshaped = melted.pivot(index="key", columns="variable",
                        values="value")  # ä½¿ç”¨ pivot å°†æ•°æ®æ¢å¤åˆ°ç±»ä¼¼åŸå§‹å¸ƒå±€
reshaped  # æ˜¾ç¤ºç»“æœ
```

```{python}
#| echo: true
reshaped.reset_index()  # å°†ç´¢å¼•ç§»å›åˆ—ä¸­
```

*   `pivot` å¯ä»¥é‡å¡‘å›åŸå§‹å¸ƒå±€ã€‚
*   ç”±äº `pivot` ä¼šåˆ›å»ºä¸€ä¸ªç´¢å¼•ï¼Œå› æ­¤ `reset_index()` å¯èƒ½å¾ˆæœ‰ç”¨ã€‚

## æ€»ç»“ ğŸ“



*   æˆ‘ä»¬ä»‹ç»äº† pandas ä¸­æ•°æ®æ•´ç†çš„å…³é”®æŠ€æœ¯ï¼š
    *   åˆ†å±‚ç´¢å¼• (MultiIndex)ã€‚
    *   `merge` (æ•°æ®åº“é£æ ¼çš„è¿æ¥)ã€‚
    *   `concat` (æ²¿è½´è¿æ¥)ã€‚
    *   `combine_first` (ä¿®è¡¥ç¼ºå¤±æ•°æ®)ã€‚
    *   `stack` å’Œ `unstack` (é‡å¡‘)ã€‚
    *   `pivot` (é•¿æ ¼å¼åˆ°å®½æ ¼å¼)ã€‚
    *   `melt` (å®½æ ¼å¼åˆ°é•¿æ ¼å¼)ã€‚
*   è¿™äº›å·¥å…·å¯¹äºä¸ºåˆ†æå‡†å¤‡æ•°æ®è‡³å…³é‡è¦ã€‚

## æ€è€ƒä¸è®¨è®º ğŸ¤”



*   å¦‚ä½•åœ¨*æ‚¨è‡ªå·±*çš„æ•°æ®åˆ†æé¡¹ç›®ä¸­åº”ç”¨è¿™äº›æŠ€æœ¯ï¼Ÿ
*   æ‚¨èƒ½æƒ³åˆ°ç°å®ä¸–ç•Œçš„ä¾‹å­å—ï¼Ÿ
*   æœ‰å“ªäº›æŒ‘æˆ˜æˆ–é™åˆ¶ï¼Ÿ
*   æ‚¨æœ€æœ‰å…´è¶£åº”ç”¨å“ªç§æ–¹æ³•ï¼Œä¸ºä»€ä¹ˆï¼Ÿ
*   åœ¨ä»€ä¹ˆæƒ…å†µä¸‹æ‚¨ä¼šæ›´å–œæ¬¢ `merge` è€Œä¸æ˜¯ `concat`ï¼Œåä¹‹äº¦ç„¶ï¼Ÿ
*   ç†è§£åˆ†å±‚ç´¢å¼•å¦‚ä½•æ”¹è¿›å¤æ‚æ•°æ®é›†çš„ç»“æ„åŒ–ï¼Ÿ


